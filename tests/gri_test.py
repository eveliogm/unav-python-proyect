import pytest
from stats.gri import *
import pandas as pd
import numpy as np
from math import trunc


def test_rsi():
    """Test Rsi"""
    r = np.array([0.2305, 0.230178, 0.230106, 0.229938, 0.229938, 0.229938, 0.229938, 0.229608, 0.229797, 0.229797, 0.230063, 0.22994, 0.229898, 0.229898, 0.229898, 0.229898, 0.229871, 0.229793, 0.229793, 0.229791, 0.229791, 0.229791, 0.229791, 0.229378, 0.229254, 0.229254, 0.229254, 0.229056, 0.229056, 0.228737, 0.228878, 0.228878, 0.229224, 0.229256, 0.229262, 0.229448, 0.229484, 0.229659, 0.229615, 0.229565, 0.229529, 0.229529, 0.229529, 0.229529, 0.228988, 0.228988, 0.229291, 0.229291, 0.229291, 0.229263, 0.229263, 0.229263, 0.229263, 0.229263, 0.229487, 0.229424, 0.229427, 0.229438, 0.229699, 0.229703, 0.229703, 0.229703, 0.229656, 0.229667, 0.229835, 0.229835, 0.23,  0.23,  0.230256, 0.230256, 0.230256, 0.230256, 0.230107, 0.229924, 0.230125, 0.230125, 0.230125, 0.229899, 0.229788, 0.229788, 0.229942, 0.229875, 0.229817, 0.229817, 0.229817, 0.229664, 0.229429, 0.229438, 0.229425, 0.229488, 0.229488, 0.229488, 0.229725, 0.229729, 0.229869, 0.229942, 0.229942, 0.230078, 0.230068, 0.230092, 0.230068, 0.230069, 0.230166, 0.230166, 0.230114, 0.230115, 0.230115, 0.230155, 0.230155, 0.230155, 0.230155, 0.230219, 0.230229, 0.230232, 0.230464, 0.230464, 0.230374, 0.230362, 0.230339, 0.230339, 0.230339, 0.230567, 0.230567, 0.230567, 0.230526, 0.230576, 0.230732, 0.230758, 0.230653, 0.2307, 0.230648, 0.230516, 0.23061, 0.23061, 0.23061, 0.23061, 0.230763, 0.230763, 0.230689, 0.230689, 0.230689, 0.230693, 0.230678, 0.230777, 0.230853, 0.230853, 0.230879, 0.230879, 0.231118, 0.231118, 0.231118, 0.231118, 0.231334, 0.231334, 0.231553, 0.231485, 0.231485, 0.231714, 0.231548, 0.231548, 0.231685, 0.23154, 0.231516, 0.231516, 0.231516, 0.231395, 0.231398, 0.231398, 0.231395, 0.231326, 0.23126, 0.23126, 0.231338, 0.231337, 0.231337, 0.231337, 0.231338, 0.231617, 0.231698, 0.231526, 0.231525, 0.231443, 0.23129, 0.23129, 0.23129, 0.231232, 0.231232, 0.231232, 0.231223, 0.231223, 0.231218, 0.231218, 0.231218, 0.231218, 0.231218, 0.231202, 0.231202, 0.231078, 0.231046, 0.231008, 0.231008, 0.231132, 0.231131, 0.231068, 0.23112, 0.23112, 0.23112, 0.23112, 0.23112, 0.231222, 0.231152, 0.231152, 0.231188, 0.231189, 0.231246, 0.23126, 0.231264, 0.231268, 0.231222, 0.231201, 0.231123, 0.230966, 0.231038, 0.230927, 0.230947, 0.231092, 0.231092, 0.231093, 0.231103, 0.231103, 0.231164, 0.231164, 0.231164, 0.231092, 0.230947, 0.230825, 0.230825, 0.230825, 0.230805, 0.230805, 0.2307, 0.2307, 0.2307, 0.230602, 0.230602, 0.230602, 0.230602, 0.230602, 0.230602, 0.23059, 0.230604, 0.230687, 0.23059, 0.230526, 0.230526, 0.230547, 0.230547, 0.230547, 0.230688, 0.230688, 0.230658, 0.230658, 0.230658, 0.230658, 0.230527, 0.230487, 0.230583, 0.230431, 0.230431, 0.230431, 0.23069, 0.230713, 0.230713, 0.230713, 0.230713, 0.230713, 0.230609, 0.230609, 0.2305, 0.230338, 0.230363, 0.230462, 0.230458, 0.23035, 0.230379, 0.230339, 0.230352, 0.230352, 0.230352, 0.230338, 0.23034, 0.23034, 0.23034, 0.23034, 0.23034, 0.23034, 0.230338, 0.230349, 0.230371, 0.230368, 0.23041, 0.23042, 0.230312, 0.230365, 0.230256, 0.230232, 0.23023, 0.23023, 0.230416, 0.230458, 0.23049, 0.230454, 0.230648, 0.230485, 0.230437, 0.2299, 0.229867, 0.230367, 0.230489, 0.230426, 0.230681, 0.230732, 0.230528, 0.230546, 0.230546, 0.230546, 0.230546, 0.230546, 0.230546, 0.230627, 0.230627, 0.230705, 0.23063, 0.230579, 0.230579, 0.230579, 0.230579, 0.230465, 0.230453, 0.230461, 0.230514, 0.230514, 0.230514, 0.230514, 0.230594, 0.230594, 0.230484, 0.230452, 0.230306, 0.230306, 0.230189, 0.230201, 0.230226, 0.230226, 0.230266, 0.230253, 0.230324, 0.230403, 0.230403, 0.230403, 0.230403, 0.230506, 0.230579, 0.230614, 0.230627, 0.230662, 0.230662, 0.230746, 0.230746, 0.230746, 0.230746, 0.230746, 0.230746, 0.230469, 0.230524, 0.231072, 0.231072, 0.230371, 0.230644, 0.230644, 0.230644, 0.230784, 0.230749, 0.230625, 0.230755, 0.230808, 0.230821, 0.230821, 0.230808, 0.230502, 0.230502, 0.230386, 0.230386, 0.230396, 0.230396, 0.23035, 0.23035, 0.230383, 0.230356, 0.230342, 0.230342, 0.230372, 0.230726, 0.230725, 0.230911, 0.230911, 0.231042, 0.231104, 0.231162, 0.231254, 0.231211, 0.2312, 0.2312, 0.2312, 0.2312, 0.231326, 0.231326, 0.231326, 0.23138, 0.23138, 0.231377, 0.231377, 0.231377, 0.231377, 0.231377, 0.231377, 0.231304, 0.231299, 0.231299, 0.231299, 0.231299, 0.231318, 0.231306, 0.231325, 0.231299, 0.2313, 0.230971, 0.230935, 0.230855, 0.230915, 0.230915, 0.230882, 0.2309, 0.23093, 0.23093, 0.230878, 0.23094, 0.23094, 0.2309, 0.2309, 0.2309, 0.230899, 0.230647, 0.230772, 0.230772, 0.230774, 0.230774, 0.230736, 0.230788, 0.230788, 0.230799, 0.230677, 0.230677, 0.230501, 0.230481, 0.230685, 0.230658, 0.230658, 0.230658, 0.23062, 0.23062, 0.230517, 0.230419, 0.2305, 0.230374, 0.230374, 0.230412, 0.230373, 0.230412, 0.230297, 0.230297, 0.230295, 0.230396, 0.230309, 0.23039, 0.230447, 0.230447, 0.230447, 0.230447, 0.230522, 0.230508, 0.230508, 0.230589, 0.230639, 0.230595, 0.230595, 0.230595, 0.230765, 0.230765, 0.230851, 0.230851, 0.230851, 0.230586, 0.230586, 0.230493, 0.230677, 0.230651, 0.230596, 0.230596, 0.230555, 0.230555, 0.230555, 0.230698, 0.230635, 0.230761, 0.230812, 0.230927, 0.230827, 0.230789, 0.230606, 0.230471, 0.230471, 0.230387, 0.230356, 0.230371, 0.230371, 0.230371, 0.230323, 0.23029, 0.23029, 0.230292, 0.230292, 0.230292, 0.230292, 0.230292, 0.230292, 0.230292, 0.230358, 0.230358, 0.230457, 0.230412, 0.230497, 0.230497, 0.230497, 0.230497, 0.230497, 0.230561, 0.230561, 0.230309, 0.23029, 0.230327, 0.23033, 0.23033, 0.23,  0.229711, 0.2298, 0.2298, 0.2298, 0.229536, 0.229479, 0.229501, 0.229487, 0.22948, 0.22948, 0.22948, 0.229453, 0.229453, 0.229453, 0.229639, 0.229634, 0.229634, 0.22962, 0.22962, 0.229273, 0.229273, 0.22935, 0.22935, 0.22935, 0.229361, 0.229374, 0.229302, 0.229082, 0.229082, 0.229082, 0.229005, 0.229005, 0.229106, 0.229081, 0.229081, 0.229031, 0.229111, 0.229083, 0.228956, 0.229022, 0.229007, 0.229031, 0.229031, 0.229217, 0.229217, 0.229217, 0.229217, 0.229182, 0.229182, 0.229182, 0.229182, 0.229182, 0.229182, 0.229226, 0.229244, 0.229244, 0.229244, 0.229244, 0.229359, 0.229359, 0.229359, 0.229359, 0.229174, 0.228993, 0.229074, 0.229087, 0.229103, 0.229113, 0.229113, 0.229186, 0.229181, 0.229219, 0.229219, 0.22933, 0.22933, 0.22933, 0.22933, 0.22933, 0.229213, 0.229213, 0.229211, 0.229255, 0.229255, 0.229392, 0.229392, 0.229283, 0.229283, 0.229511, 0.229412, 0.229412, 0.22956, 0.229537, 0.229605, 0.229398, 0.229724, 0.229722, 0.229715, 0.229675, 0.229635, 0.22971, 0.229672, 0.229672, 0.229758, 0.229758, 0.229733, 0.229741, 0.229741, 0.229528, 0.229267, 0.229182, 0.229182, 0.229428, 0.229025, 0.229025, 0.2282, 0.228261, 0.228787, 0.228413, 0.228413, 0.228197, 0.228197, 0.228197, 0.228463, 0.2288, 0.228652, 0.228501, 0.228501, 0.228461, 0.228461, 0.228461, 0.228461, 0.228461, 0.228577, 0.228406, 0.228406, 0.228196, 0.22848, 0.228401, 0.228436, 0.228372, 0.228293, 0.227709, 0.227544, 0.227544, 0.227957, 0.227957, 0.227864, 0.227864, 0.227916, 0.227916, 0.22782, 0.227916, 0.227916, 0.228058, 0.228029, 0.228138, 0.228137, 0.228137, 0.227872, 0.227632, 0.227522, 0.227838, 0.227838, 0.228047, 0.228033, 0.228138])
    ser = pd.Series(r, copy = False)
    r_exp = np.array([np.nan, np.nan, np.nan , np.nan , np.nan , np.nan, np.nan , np.nan , np.nan , np.nan , np.nan , np.nan, np.nan , np.nan, 36.37067578, 36.37067578, 35.1166257, 31.71459521, 31.71459521, 31.62349068, 31.62349068, 31.62349068, 31.62349068, 17.5892858, 15.38205085, 15.38205085, 15.38205085, 12.30304492, 12.30304492, 8.95407151, 19.39787507, 19.39787507, 39.23497561, 40.6888491, 40.97401797, 49.13805729, 50.56328964, 56.88762518, 54.98306968, 52.81901544, 51.25481987, 51.25481987, 51.25481987, 51.25481987, 32.0623851, 32.0623851, 45.35377154, 45.35377154, 45.35377154, 44.35228427, 44.35228427, 44.35228427, 44.35228427, 44.35228427, 55.69044935, 52.45342126, 52.59472634, 53.1445892, 63.85694694, 63.9928154, 63.9928154, 63.9928154, 60.64705053, 61.15889183, 68.00367134, 68.00367134, 73.35259913, 73.35259913, 79.51475998, 79.51475998, 79.51475998, 79.51475998, 67.32632081, 55.97722611, 63.29573382, 63.29573382, 63.29573382, 51.31561556, 46.64581264, 46.64581264, 53.46038907, 50.44182818, 47.91940958, 47.91940958, 47.91940958, 41.14112243, 33.34031847, 33.85757109, 33.45376764, 37.35314596, 37.35314596, 37.35314596, 50.87744331, 51.06943921, 57.35232407, 60.2205736, 60.2205736, 65.26766286, 64.61845345, 65.50527324, 63.78359404, 63.8262562, 67.78983006, 67.78983006, 63.46630773, 63.51449971, 63.51449971, 65.61845263, 65.61845263, 65.61845263, 65.61845263, 69.41417646, 69.97200437, 70.14790235, 79.936078, 79.936078, 69.65985834, 68.39729582, 65.93074776, 65.93074776, 65.93074776, 76.44694893, 76.44694893, 76.44694893, 71.49074501, 73.72770327, 79.20903351, 79.95949769, 69.11027678, 71.00663493, 66.1667367, 55.77411222, 60.52862853, 60.52862853, 60.52862853, 60.52862853, 68.04868118, 68.04868118, 61.47857876, 61.47857876, 61.47857876, 61.72804707, 60.15479161, 66.26583413, 70.06184399, 70.06184399, 71.34134965, 71.34134965, 80.31184044, 80.31184044, 80.31184044, 80.31184044, 85.73838852, 85.73838852, 89.22919898, 82.47851207, 82.47851207, 86.47496929, 73.40467941, 73.40467941, 76.76593711, 67.09985889, 65.62689689, 65.62689689, 65.62689689, 57.65704108, 57.79389726, 57.79389726, 57.57806832, 52.70305305, 48.47521661, 48.47521661, 53.57926147, 53.50608161, 53.50608161, 53.50608161, 53.58525966, 69.29590026, 72.23430745, 59.26438197, 59.19783075, 53.85706584, 45.59196363, 45.59196363, 45.59196363, 42.5036435, 42.5036435, 42.5036435, 41.95288099, 41.95288099, 41.60551604, 41.60551604, 41.60551604, 41.60551604, 41.60551604, 40.06774223, 40.06774223, 30.07614726, 28.126867, 25.97403653, 25.97403653, 42.60062331, 42.51768568, 37.55689796, 43.42445414, 43.42445414, 43.42445414, 43.42445414, 43.42445414, 55.34645124, 47.88828447, 47.88828447, 51.7651197, 51.87222721, 57.64545009, 58.94800108, 59.33281907, 59.73925079, 53.15953379, 50.4288426, 41.83329596, 30.54697413, 38.71309103, 32.39023021, 34.46708884, 47.14402387, 47.14402387, 47.22567813, 48.08930522, 48.08930522, 53.47552731, 53.47552731, 53.47552731, 46.38098909, 36.017559, 29.95321914, 29.95321914, 29.95321914, 28.95501967, 28.95501967, 24.07082022, 24.07082022, 24.07082022, 20.11542742, 20.11542742, 20.11542742, 20.11542742, 20.11542742, 20.11542742, 19.50326137, 22.46777661, 37.22753711, 30.03204765, 26.40557366, 26.40557366, 29.63883871, 29.63883871, 29.63883871, 48.58241358, 48.58241358, 45.55588397, 45.55588397, 45.55588397, 45.55588397, 33.35244382, 30.65237229, 42.65186374, 32.93465749, 32.93465749, 32.93465749, 54.83380264, 56.20153359, 56.20153359, 56.20153359, 56.20153359, 56.20153359, 46.89938603, 46.89938603, 39.04423558, 30.79009923, 33.13917028, 41.5933265, 41.36573881, 35.6877703, 38.14304265, 36.09606704, 37.27424602, 37.27424602, 37.27424602, 36.3722744, 36.60826964, 36.60826964, 36.60826964, 36.60826964, 36.60826964, 36.60826964, 36.3976792, 38.49337722, 42.56919994, 42.15893323, 49.49728066, 51.088423, 37.38797769, 45.16019423, 35.42169891, 33.69857307, 33.55209564, 33.55209564, 54.76120829, 58.01963843, 60.36220671, 56.53979454, 68.21920804, 54.8754561, 51.67029026, 30.32820646, 29.52124114, 50.85708428, 54.4782239, 52.33369857, 59.31486945, 60.55903737, 53.51009899, 54.01867197, 54.01867197, 54.01867197, 54.01867197, 54.01867197, 54.01867197, 57.29785015, 57.29785015, 60.44799792, 56.15811855, 53.3837398, 53.3837398, 53.3837398, 53.3837398, 46.47988492, 45.80831985, 46.36469438, 50.02531918, 50.02531918, 50.02531918, 50.02531918, 56.1073561, 56.1073561, 46.98810774, 44.71143891, 36.11390466, 36.11390466, 30.63840461, 31.78085068, 34.21197371, 34.21197371, 38.29260363, 37.47895688, 44.42446932, 50.95337815, 50.95337815, 50.95337815, 50.95337815, 59.33177729, 64.02262886, 66.04486482, 66.79150539, 68.78182579, 68.78182579, 73.24513679, 73.24513679, 73.24513679, 73.24513679, 73.24513679, 73.24513679, 42.20506134, 47.00713662, 71.98430222, 71.98430222, 42.36239175, 50.84571409, 50.84571409, 50.84571409, 55.08034773, 53.83176377, 49.54654699, 53.70713398, 55.32465103, 55.73321955, 55.73321955, 55.14829692, 43.55967751, 43.55967751, 39.87572427, 39.87572427, 40.37984428, 40.37984428, 38.65093852, 38.65093852, 40.76121003, 39.5621396, 38.92277241, 38.92277241, 41.28113623, 60.60933821, 60.54870646, 67.13437772, 67.13437772, 71.07799623, 72.74488324, 74.24055168, 76.44832089, 73.28671535, 72.46114546, 72.46114546, 72.46114546, 72.46114546, 76.53388289, 76.53388289, 76.53388289, 78.25524531, 78.25524531, 77.88712176, 77.88712176, 77.88712176, 77.88712176, 77.88712176, 77.88712176, 66.08655279, 65.35616138, 65.35616138, 65.35616138, 65.35616138, 67.20852337, 64.85009443, 66.83454998, 61.70104309, 61.82250271, 29.11163218, 27.40305061, 24.02814536, 30.90162214, 30.90162214, 29.21557308, 31.41378233, 35.03491752, 35.03491752, 31.67326951, 39.16800371, 39.16800371, 36.19717292, 36.19717292, 36.19717292, 36.11164895, 22.00310093, 35.47059562, 35.47059562, 35.6766905, 35.6766905, 33.33094877, 39.22019071, 39.22019071, 40.50945449, 32.32074235, 32.32074235, 24.15229073, 23.42770436, 42.40720701, 40.96012639, 40.96012639, 40.96012639, 38.64225466, 38.64225466, 32.80634051, 28.41000104, 36.03938841, 30.57998926, 30.57998926, 34.07310118, 32.27795613, 35.91405242, 30.68267086, 30.68267086, 30.5927889, 40.13082099, 35.59342644, 42.15142905, 46.29549474, 46.29549474, 46.29549474, 46.29549474, 52.33817734, 51.18053256, 51.18053256, 57.48976567, 60.85296123, 56.60863588, 56.60863588, 56.60863588, 67.5353197, 67.5353197, 71.71430483, 71.71430483, 71.71430483, 47.95641449, 47.95641449, 42.25842286, 53.92321122, 52.31495843, 48.98660143, 48.98660143, 46.43261996, 46.43261996, 46.43261996, 56.34691061, 51.79842341, 58.93770855, 61.42799881, 66.37936502, 59.25619251, 56.76344993, 46.59729792, 40.7931038, 40.7931038, 37.42875183, 36.24085109, 37.27815939, 37.27815939, 37.27815939, 35.002199, 33.48842065, 33.48842065, 33.68999323, 33.68999323, 33.68999323, 33.68999323, 33.68999323, 33.68999323, 33.68999323, 43.22832879, 43.22832879, 54.59132747, 49.71992773, 57.44453712, 57.44453712, 57.44453712, 57.44453712, 57.44453712, 63.55173461, 63.55173461, 38.39160592, 37.19591632, 41.04648343, 41.36041279, 41.36041279, 24.62903594, 17.82751303, 24.72202497, 24.72202497, 24.72202497, 18.85959745, 17.87406186, 19.61996676, 19.33822778, 19.18984793, 19.18984793, 19.18984793, 18.50580101, 18.50580101, 18.50580101, 37.63371019, 37.37971904, 37.37971904, 36.57806015, 36.57806015, 22.62810976, 22.62810976, 29.54331126, 29.54331126, 29.54331126, 30.64924432, 32.00756574, 28.65950129, 21.320796, 21.320796, 21.320796, 19.17446736, 19.17446736, 29.9083985, 28.88581638, 28.88581638, 26.76333166, 34.99371294, 33.57165637, 28.0114297, 34.11818066, 33.42421202, 35.67852716, 35.67852716, 50.68684901, 50.68684901, 50.68684901, 50.68684901, 47.86036831, 47.86036831, 47.86036831, 47.86036831, 47.86036831, 47.86036831, 53.00009945, 54.95628979, 54.95628979, 54.95628979, 54.95628979, 66.82269845, 66.82269845, 66.82269845, 66.82269845, 42.56141313, 30.78485387, 38.92871845, 40.14593012, 41.68642429, 42.67940714, 42.67940714, 49.90187727, 49.44235553, 52.98573075, 52.98573075, 62.00658041, 62.00658041, 62.00658041, 62.00658041, 62.00658041, 47.95718245, 47.95718245, 47.74272525, 52.74890273, 52.74890273, 64.89352407, 64.89352407, 52.45348543, 52.45348543, 67.54611181, 58.81588018, 58.81588018, 66.35530047, 64.38274838, 67.46241649, 52.5629863, 65.48970668, 65.37201116, 64.93216631, 62.35053348, 59.79046717, 62.86893357, 60.34792262, 60.34792262, 64.12388979, 64.12388979, 62.12922855, 62.53088741, 62.53088741, 47.10422292, 35.53549919, 32.71733298, 32.71733298, 46.86205675, 34.18365751, 34.18365751, 20.81406345, 23.20566831, 40.02631524, 34.27733155, 34.27733155, 31.26909305, 31.26909305, 31.26909305, 39.44336248, 47.89781949, 44.93102931, 42.06801804, 42.06801804, 41.2602969, 41.2602969, 41.2602969, 41.2602969, 41.2602969, 45.6443472, 40.80905102, 40.80905102, 35.45903005, 45.80641484, 43.70727083, 44.91175339, 43.0959,  40.89777563, 29.08685964, 26.73744547, 26.73744547, 40.65290854, 40.65290854, 38.73165819, 38.73165819, 40.55349073, 40.55349073, 38.12614057, 41.87299498, 41.87299498, 47.34316518, 46.38315137, 50.45016465, 50.41238398, 50.41238398, 40.98047911, 34.65641993, 32.20347521, 44.38208806, 44.38208806, 51.11761189, 50.67490521, 53.89965235])
    s_exp = pd.Series(r_exp, copy = False)
    observed = rsi(data = ser,win = 14 , ma = "EWMA")
    assert len(observed) == len(s_exp) 
    assert all([round(a, 2) == round(b, 2) for a, b in zip(observed.dropna().to_list(), s_exp.dropna().to_list())])